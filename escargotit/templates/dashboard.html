{% extends "base/base.html" %}
{% load filters %}
{% load static %}

{% block title %}
    Dashboard
{% endblock %}

{% block scripts %}
    <script type="text/javascript" src="{% static 'js/dashboard.js' %}" defer></script>
{% endblock %}


{% block content %}

<div class="container main">

    <!-- Add messages section here -->
    {% if messages %}
        <div class="alert alert-warning">
            {% for message in messages %}
                <p>{{ message }}</p>
            {% endfor %}
        </div>
    {% endif %}


    <div class="row">
        <div class="col">
            <!-- Left side content -->
            <h1>Welcome, {{ user.username }}!</h1>
            {% if is_admin %}
                <h3>Account type: Admin</h3>
            {% else %}
                <h3>Account type: Employee</h3>
            {% endif %}
            <p>User Profile Information:</p>
            <ul>
                <li>Business name: {{ current_user.business_name }}</li>
                <li>Company tax code: {{ current_user.company_tax_code }}</li>
            </ul>


            <!-- Container to display selected snail bed data stats -->
            <h3>Select a Snail Bed to see information</h3>
            <div id="selected-box-data" style="display: none;">
                <div id="box-name"></div>
                <div id="box-employee"></div>
                <div id="box-hatch"></div>
                <div id="box-mortality"></div>
                <div id="box-maturity"></div>
                <div id="box-snails"></div>
                <div id="box-details"></div>
                <div id="box-feed"></div>
                <div id="box-api"></div>
            </div>




        </div>
        <div class="col">
            <!-- Right side content -->

            <h2>Snail Bed Boxes</h2>

            {% if error_message %}
                <h3>{{ error_message }}</h3>
            {% else %}
                <h3>Number of Snail Beds: {{ snail_bed_count }}</h3>

                <div class="rectangle">
                    <h5>Bed Performance visible for each snail bed</h5>
                    <!-- Existing SnailBed boxes -->
                    {% for snail_bed in snail_beds %}
                        <div class="snail-box {% if snail_bed.is_empty %}empty{% else %}solid{% endif %}
                        {% if snail_bed.snailbedperformance.bed_performance < 30 %}
                            red-bg
                        {% elif snail_bed.snailbedperformance.bed_performance >= 30 and snail_bed.snailbedperformance.bed_performance <= 70 %}
                            yellow-bg
                        {% elif snail_bed.snailbedperformance.bed_performance > 70 %}
                            green-bg
                        {% endif %}"
                                data-bed-name="{{ snail_bed.bed_name }}"
                                data-bed-employee="{{ snail_bed.employee }}"
                                data-bed-id="{{ snail_bed.id }}"
                                data-bed-hatch="{{ snail_bed.hatch_rate }}"
                                data-bed-mortality="{{ snail_bed.mortality_rate }}"
                                data-bed-maturity="{{ snail_bed.maturity_rate }}"
                                data-bed-snails="{{ snail_bed.snail_amount }}">
                            <span>{{ snail_bed.name }}</span>
                            {% if snail_bed.snailbedperformance.bed_performance %}
                                <p>{{ snail_bed.snailbedperformance.bed_performance|floatformat:"0" }}%</p>
                            {% else %}
                                <p>No Performance data available yet</p>
                                <p>Click on this bed and then "See Performance" to generate</p>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>

                {% if snail_bed_count > 0 %}
                    <button type="button" class="btn btn-primary" 
                            id="logDataButton"
                            data-snail-bed-id="{{ snail_bed.id }}">
                        Log Data
                    </button>
                {% endif %}

                {% with current_user|classname as modelclass %}
                    {% if modelclass == "AdminUser" %}
                        <!-- Button to view barchart -->
                        <button id="view-barchart-button" class="btn btn-success">View Barchart & Correlations</button>
                    {% endif %}
                

                    <!-- Conditional check to display the "Create Box" button for admins only -->
                    {% if current_user.can_create_snailbed %}
                        <form method="POST" action="{% url 'dashboard' %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-primary" name="add-box-button">Add Box</button>
                        </form>

                        {% if snail_bed_count > 0 %}
                        
                            {% if modelclass == "AdminUser" %}
                                <!-- Button to delete all SnailBed objects for this user -->
                                <form method="POST" action="{% url 'delete_all_snailbeds' %}">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-danger" name="delete-all-boxes-button">Delete All Boxes</button>
                                </form>

                                <!-- Add a button to delete the selected snail bed -->
                                <button type="button" class="btn btn-danger" id="delete-snail-bed-button">Delete Selected Snail Bed</button>

                            {% endif %}
                            
                        {% endif %}
                    {% endif %}
                {% endwith %}
                
            {% endif %}
        </div>
    </div>
    
</div>



<!-- this is the pop up with the options to log data for the selected snail bed. This pops up on screen when "Log data" is clicked -->
<div class="modal fade" id="logDataModal" tabindex="-1" aria-labelledby="logDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logDataModalLabel">Log Data Options</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Select an option:</p>
                <ul>
                    <li><a id="box-hatch-link" href="log_hatch_rate/">Log Hatched Snails</a></li>
                    <li><a id="box-mortality-link" href="log_mortality_rate/">Log Snails Expired</a></li>
                    <li><a id="box-feed-link" href="log_snail_feed/">Log Feed Given</a></li>
                    <li><a id="box-maturity-link" href="log_maturity_rate/">Time taken to reach Maturity</a></li>
                   
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>





<style>
    .main.container{
        min-height: 20rem;
    }

    .rectangle {
        /*width: 50%; /* Takes the right half of the screen */
        width: 30rem;
        border: 2px solid #ccc;
        padding: 10px;
        display: flex;
        flex-wrap: wrap;
        border-radius: 5%;
    }

    .snail-box {
        width: calc(50% - 20px); /* 25% of the rectangle width with some spacing */
        height: 10rem;
        border: 2px dashed #ccc;
        margin: 10px;
        padding: 10px;
        box-sizing: border-box;
        transition: border 0.3s ease-in-out;
        cursor: pointer;
        border-radius: 5%;
    }

    .snail-box.empty {
        background-color: #f0f0f0;
    }

    .snail-box.expanded {
        border: 2px solid #000;
    }

    /* Add conditional background color to each snail bed based on performance % */
    .snail-box.red-bg {
        background-color: rgba(255, 0, 0, 0.486);
    }

    .snail-box.yellow-bg {
        background-color: rgba(255, 196, 0, 0.561);
    }

    .snail-box.green-bg {
        background-color: rgba(0, 255, 0, 0.5);
    }

    .snail-box a {
        display: block;
        width: 100%;
        height: 100%;
        text-decoration: none;
        color: inherit;
    }
</style>
{% endblock %}